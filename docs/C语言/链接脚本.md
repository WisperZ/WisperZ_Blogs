---
tags:
  - "#C语言"
  - "#LD"
created: 2024-12-13
Last Modified: 2024-12-13
---
## 链接脚本

### 概论
每一个链接过程都由链接脚本 (linker script, 一般以 lds 作为文件的后缀名) 控制. 链接脚本主要用于规定如何把输入文件内的 section 放入输出文件内, 并控制输出文件内各部分在程序地址空间内的布局. 但你也可以用连接命令做一些其他事情.

连接器有个默认的内置连接脚本, 可用 ld --verbose 查看. 连接选项-r 和-N 可以影响默认的连接脚本 (如何影响?).

-T 选项用以指定自己的链接脚本, 它将代替默认的连接脚本。你也可以使用<暗含的连接脚本>以增加自定义的链接命令.

以下没有特殊说明，连接器指的是静态连接器.

在链接脚本和链接过程中，**section（段）** 是指程序中的内存区域或数据段，用于存放特定类型的数据或代码。每个 section 通常有其特定的用途，表示不同种类的内容，如代码、数据、符号、调试信息等。

#### **Section 的基本概念：**

1. **代码段（Text Segment）**：
    - 存放程序的可执行代码。
    - 通常标记为 `.text`，它是大多数程序的主要部分。
    - 该段通常是只读的。
3. **数据段（Data Segment）**：
    - 存放已初始化的全局变量和静态变量。
    - 标记为 `.data`，用于存放在程序中**显式初始化**的变量的值。
3. **BSS 段（Block Started by Symbol Segment）**：
    - 存放**未初始化**的**全局变量**和**静态变量**。
    - 标记为 `.bss`，通常在程序启动时将其清零。
4. **堆（Heap）**：
    - 用于动态分配内存的区域，通常由 `malloc`、`free` 等函数管理。虽然它在连接时不直接涉及，但它的大小和位置也是程序运行时的重要部分。
5. **栈（Stack）**：
    - 用于存储函数调用信息、局部变量等。在程序运行时自动增长和缩小。
6. **只读数据段（RO Data Segment）**：
    - 存放常量数据，标记为 `.rodata`，这部分数据在程序运行时不可修改。
7. **符号表和调试信息（Symbol Table and Debug Information）**：
    - 存放符号表、调试信息等，用于调试和链接过程中符号解析。通常这些信息存储在 `.symtab`、`.debug` 等 section 中。

#### **数据段（Data Segment）和 BSS 段（BSS Segment）的差别：**
- **数据段**存储的是**已初始化的**全局变量和静态变量，程序启动时会根据源代码中的初始值加载它们。
- **BSS 段**存储的是**未初始化的**全局变量和静态变量，在程序启动时，操作系统会自动将它们初始化为零。
- 数据段需要占用更多的磁盘空间，因为它存储了初始值，而 BSS 段则不会占用磁盘空间，只会在内存中占用空间。

链接脚本（Linker Script）是一个指示链接器如何组织和放置这些不同 section 的文件。通过链接脚本，你可以控制以下内容：
- **定义各个 section 在内存中的布局**。
- **指定各个 section 的起始地址**。
- **控制 section 的合并和分配**。

例如，链接脚本中的 `SECTIONS` 块可以如下配置：
```ld
SECTIONS {
  .text : { *(.text) }  /* 所有 `.text` 段的内容合并到输出文件的 `.text` 部分 */
  .data : { *(.data) }  /* 所有 `.data` 段的内容合并到输出文件的 `.data` 部分 */
  .bss : { *(.bss) }    /* 所有 `.bss` 段的内容合并到输出文件的 `.bss` 部分 */
}
```

#### **链接选项与 Section 的关系**：
1. **`-r` 选项**：  
    使用 `-r` 选项时，`ld` 只生成一个目标文件（而不是可执行文件），并保留每个输入文件的原始 section。此时，链接器会将各个 section 保留在目标文件中，便于后续处理或生成静态库。
    
2. **`-N` 选项**： `-N` 选项用于禁止链接器自动将某些 section 合并。如果不使用该选项，链接器可能会合并某些 section（例如 `.text` 和 `.data`）来减少文件大小。使用 `-N` 选项时，链接器会保留这些 section 的原始布局和内容。
    
3. **`-T` 选项**： `-T` 选项用于指定一个自定义的链接脚本，它会覆盖链接器的默认脚本。默认情况下，链接器使用其内置的链接脚本来决定如何将不同的 section 放置到内存中。而通过 `-T` 指定自定义脚本后，你可以完全控制各个 section 的布局和顺序。例如：
```bash
ld -T my_linker_script.ld
```
链接脚本中的 Section 示例：
链接脚本常见的 `SECTIONS` 配置示例可能如下所示：
```ld
SECTIONS {
  /* 定义代码段位置 */
  .text : {
    *(.text)  /* 将所有 .text 段内容合并到此 */
    *(.text.*)  /* 处理可能的子段 */
  }

  /* 定义数据段位置 */
  .data : {
    *(.data)  /* 将所有 .data 段内容合并到此 */
  }

  /* 定义未初始化数据段位置 */
  .bss : {
    *(.bss)  /* 将所有 .bss 段内容合并到此 */
  }

  /* 符号表 */
  .symtab : {
    *(.symtab)
  }

  /* 调试信息 */
  .debug : {
    *(.debug)
  }
}

```