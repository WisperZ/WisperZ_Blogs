## 随记

> 一些不知道该如何分类的东西  

### 变量传递问题（二级指针）

```c
int _mqtt_client_init(cm_mqtt_client_t **mqtt_client)

{
    if(*mqtt_client){
        // cm_log_printf(0,"\r\n[MQTT]CM MQTT CLIENT IS RUN!!!\r\n");
        return -1;
    }
    *mqtt_client = cm_mqtt_client_create();  //client初始化，最大支持五个实例
    if (NULL == *mqtt_client){
        // cm_log_printf(0,"[MQTT]CM MQTT CREATE CLIENT ERROR!!!\r\n");
        return -1;
    }
    /* 设置回调函数 */
    cm_mqtt_client_cb_t callback = {0};
    callback.connack_cb = __mqtt_manager_default_connack_cb;    //连接状态回调
    callback.publish_cb = __mqtt_manager_default_publish_cb;    //server->client发布消息回调
    callback.puback_cb = __mqtt_manager_default_puback_cb;      //client->server发布消息ack回调
    callback.pubrec_cb = __mqtt_manager_default_pubrec_cb;      //client->server发布消息recv回调
    callback.pubcomp_cb = __mqtt_manager_default_pubcomp_cb;    //client->server发布消息comp回调
    callback.suback_cb = __mqtt_manager_default_suback_cb;      //订阅ack回调
    callback.unsuback_cb = __mqtt_manager_default_unsuback_cb;  //取消订阅ack回调
    callback.pingresp_cb = __mqtt_manager_default_pingresp_cb;  //ping回调
    callback.timeout_cb = __mqtt_manager_default_timeout_cb;    //消息超时回调，包括publish/subscribe/unsubscribe等
    /* 设置client参数 */
    int version = 4;//版本3.1.1
    int pkt_timeout = 10;//发送超时10秒
    int reconn_times = 3;//重连三次
    int reconn_cycle = 20;//重连间隔20秒
    int reconn_mode = 0;//以固定间隔尝试重连
    int retry_times = 3;//重传三次
    int ping_cycle = 60;//ping周期60秒
    int dns_priority = 2;//MQTT dns解析ipv6优先

    cm_mqtt_client_set_opt(*mqtt_client, CM_MQTT_OPT_EVENT, (void*)&callback);
    cm_mqtt_client_set_opt(*mqtt_client, CM_MQTT_OPT_VERSION, (void*)&version);
    cm_mqtt_client_set_opt(*mqtt_client, CM_MQTT_OPT_PKT_TIMEOUT, (void*)&pkt_timeout);
    cm_mqtt_client_set_opt(*mqtt_client, CM_MQTT_OPT_RETRY_TIMES, (void*)&retry_times);
    cm_mqtt_client_set_opt(*mqtt_client, CM_MQTT_OPT_RECONN_MODE, (void*)&reconn_mode);
    cm_mqtt_client_set_opt(*mqtt_client, CM_MQTT_OPT_RECONN_TIMES, (void*)&reconn_times);
    cm_mqtt_client_set_opt(*mqtt_client, CM_MQTT_OPT_RECONN_CYCLE, (void*)&reconn_cycle);
    cm_mqtt_client_set_opt(*mqtt_client, CM_MQTT_OPT_PING_CYCLE, (void*)&ping_cycle);
    cm_mqtt_client_set_opt(*mqtt_client, CM_MQTT_OPT_DNS_PRIORITY, (void*)&dns_priority);
    return 0;
}
```

这里在我修改的时候，我最初是将参数设置为指针 `cm_mqtt_client_t *mqtt_client`, 传入的是一个一级指针，在调试的过程中时钟未发现这里实际上是修改了这个指针的指向，创建了一个新的 `cm_mqtt_client_t` 对象，然后将这个对象的地址赋予了 `mqtt_client` 指针，然而使用一级指针的话，这里就相当于修改了传进来的指针的指向，所以会导致函数返回时，这个指向的地址丢失。